



[[جدول قواعد جدار الحماية الأساسية]]

فيه المكونات، البروتوكولات، المنافذ، وقواعد الدخول والخروج

| المكون         | البروتوكول   | المنافذ     | قواعد الوارد (Inbound) | قواعد الصادر (Outbound)    | مستوى الحساسية |
| -------------- | ------------ | ----------- | ---------------------- | -------------------------- | -------------- |
| لوحة التحكم    | HTTPS        | 443         | من شبكات الإدارة فقط   | إلى واجهة API (443)        | تحت التقيم     |
| واجهة API      | gRPC / HTTPS | 50051 / 443 | من لوحة التحكم (443)   | إلى الخادم المركزي (50051) | تحت التقيم     |
| الخادم المركزي | gRPC         | 50051       | من واجهة API والوكلاء  | إلى الوكلاء ودليل الوكلاء  | تحت التقيم     |
| الوكلاء        | gRPC         | 50051       | من الخادم المركزي فقط  | إلى الخادم المركزي (50051) | تحت التقيم     |



## 🌐 بوابة API (المسؤولية الرئيسية)

| المهمة                  | القواعد الواردة (Inbound)                                         | القواعد الصادرة (Outbound)                          | الأدوات                  | المستوى    |
| ----------------------- | ----------------------------------------------------------------- | --------------------------------------------------- | ------------------------ | ---------- |
| **مصادقة الطلبات**      | قبول فقط طلبات تحمل JWT صالح في الهيدر                            | رفض الطلبات غير الموثقة مع إرجاع `401 Unauthorized` | `golang-jwt/jwt`         | تحت التقيم |
| **التحقق من الصلاحيات** | تطبيق سياسات RBAC قبل معالجة الطلب                                | إرجاع `403 Forbidden` للطلبات غير المصرح بها        | `Casbin`                 | تحت التقيم |
| **Rate Limiting**       | قبول حد أقصى ١٠٠ طلب/ثانية من نفس IP                              | إرجاع `429 Too Many Requests` عند التجاوز           | `golang.org/x/time/rate` | تحت التقيم |
| **تصفية المدخلات**      | رفض الطلبات تحتوي على: `'; DROP TABLE'` أو `'<script>'`           | إرجاع `400 Bad Request` مع رسالة خطأ عامة           | مكتبات التطهير           | تحت التقيم |
| **التسجيل الأمني**      | تسجيل: IP المصدر، المسار، رمز الاستجابة (مع حجب البيانات الحساسة) | إرسال السجلات إلى نظام المراقبة عبر TLS             | `Structured Logging`     | تحت التقيم |
| **إدارة الأخطاء**       | عدم تسريب تفاصيل النظام في الأخطاء                                | إرجاع `500 Internal Server Error` مع رسالة عامة فقط | معالجات الأخطاء المخصصة  | تحت التقيم |

---

###  جدار الحماية في خادم gRPC (Server Firewall Logic)

الخادم هو الحصن الرئيسي، وجدار الحماية الخاص به يركز على التحقق من هوية المتصل وصلاحياته قبل السماح له بالدخول.
##  جدول قواعد جدار الحماية في خادم gRPC

| 🧱 القاعدة                             | 📥 النوع         | 🎯 الهدف                                 | 🔧 مكان التنفيذ                          |
| -------------------------------------- | ---------------- | ---------------------------------------- | ---------------------------------------- |
| ✅ قبول فقط عملاء مع شهادة mTLS صالحة   | واردة (Inbound)  | التحقق من الهوية (Identity Verification) | [[tls.Config في]] `/cmd/server/main.go   |
| ❌ رفض الاتصالات الفاشلة بـ mTLS        | صادرة (Outbound) | قطع الاتصال فوراً إذا فشل التحقق         | تلقائي من TLS/gripe  [[tls.Config في]]   |
| 🔐 فحص صلاحيات العميل بالصلاحيات       | واردة (Inbound)  | التأكد مما يُسمح للعميل بفعله            | [[auth_interceptor.go]] في `interceptor` |
|                                        |                  |                                          |                                          |
| ⏳ إغلاق الاتصالات الخاملة بعد 60 ثانية | واردة (Inbound)  | الحماية من استنزاف الموارد               | [[Keepalive]].ServerParameters`          |


##  العميل (لوحة التحكم)

| المهمة                 | القواعد الواردة (Inbound)                 | القواعد الصادرة (Outbound)                                | الأدوات                 | المستوى    |
| ---------------------- | ----------------------------------------- | --------------------------------------------------------- | ----------------------- | ---------- |
| **إدارة الجلسات**      | قبول فقط توكنات JVM عبر قنوات HTTPS       | تخزين التوكنات في `HttpOnly` + `Secure` cookies           | `httpOnly cookies`      | تحت التقيم |
| **التحقق من الشهادات** | التحقق من توقيع شهادة الخادم عند كل اتصال | رفض الاتصال إذا فشل التحقق من الشهادة                     | `tls.Config`            | تحت التقيم |
| **مناولة الأخطاء**     | عدم عرض تفاصيل الخطأ الداخلية للمستخدم    | تسجيل الأخطاء الكاملة في نظام المراقبة                    | تصميم واجهات أخطاء آمنة | تحت التقيم |
| **تحديث آمن**          | قبول تحديثات فقط من مصادر موقعة رقمياً    | التحقق من التوقيع الرقمي قبل التثبيت                      | `ed25519` للتوقيع       | تحت التقيم |
| **التحكم في CORS**     | رفض طلبات CORS من نطاقات غير مسجلة        | إرسال `Access-Control-Allow-Origin` للنطاقات المسموحة فقط | `CORS middleware`       | تحت التقيم |


## توضيحات أساسية

1. **قواعد الواردة (Inbound)**:
   - الشروط التي يجب أن تستوفيها البيانات قبل معالجتها
   - مثال: التحقق من صحة التوكن قبل تنفيذ الطلب

2. **قواعد الصادرة (Outbound)**:
   - الإجراءات المتخذة عند إرسال البيانات/الردود
   - مثال: تشفير جميع البيانات المرسلة إلى الخادم المركزي

3. **أولويات التنفيذ**:
   - البدء بالمهام ذات المستوى "عالي" أولاً
   - اختبار كل قاعدة أمنية بسيناريوهات هجوم واقعية


