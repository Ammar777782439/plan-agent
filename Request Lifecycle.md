
---

### دورة حياة الطلب (Request Lifecycle) في النظام حقنا

لشرح الكامل لكيف الطلب بيمشي في النظام حقنا من أول ما يجي من العميل لغاية ما يوصل للوكيل ويتنفذ، خطوة بخطوة، على حسب التصميم اللي خططنا له.

الرحلة هذه قسمناها لخمس خطوات أساسية:

###  الخطوة الأولى: الفحص الأمني (ما يدخل إلا المصرح له)

هذه أول وأهم نقطة تفتيش. قبل ما نشوف ايش داخل الطلب، لازم نتأكد من هو اللي أرسله.

1. **الاتصال المبدئي:** العميل يحاول يشبك على السيرفر حقنا.
2. **فحص `mTLS`:** السيرفر على طول يوقفه ويقول له: "وريني هويتك". لازم العميل يطلع شهادة رقمية (`certificate`) أصلية وموقعة من جهة إحنا نثق فيها. أي جهاز ثاني ما معه هذه الشهادة، بينطرد من قبل حتى ما يوصل للتطبيق حقنا.
3. **الـ `Interceptor` (المعترض):** لو نجح الاتصال وعدى من الفحص الأول، يجي دور الـ `Interceptor` حقنا. هذا زي الحارس الثاني اللي يتأكد مش بس إن الشخص معه بطاقة دخول، بس هل مسموح له يدخل هذا القسم بالذات. يعني نتأكد هل هوية العميل اللي في الشهادة مسموح لها تسوي هذا النوع من الطلبات.
4. **القرار:** لو فشل في أي فحص من هذه، على طول يتم رفض طلبه وينتهي الموضوع هنا.

---

### ✅ الخطوة الثانية: تسجيل الطلب (استلمنا طلبك، ارتاح)

بعد ما نتأكد إن الوضع الأمني سليم، نستلم الطلب رسميًا.

1. **الحفظ في الداتابيز:** السيرفر يسجل الطلب في جدول `REQUESTS` ويعطيه حالة `pending` (يعني قيد الانتظار).
2. **الرد الفوري:** وهنا الحركة الذكية، السيرفر يرجع للعميل رد سريع ومعه رقم متابعة فريد (`request_id`) ويقول له: "طلبك وصل واستلمناه، وهذا رقمه. تقدر تروح تكمل شغلك".
3. **الزبدة:** العميل ما يجلس ينتظر الشغل يخلص، وهذا يخلي النظام حقنا سريع الاستجابة وما يعلقش.هذا التصميم غير المتزامن (Asynchronous)

---

### 🧠 الخطوة الثالثة: العقل المدبر (ندور على الوكيل الصح)

هذه الخطوة كلها تحصل في الخلفية، السيرفر يبدأ يفكر.

1. **فهم الطلب:** السيرفر يفتح الطلب ويشوف تفاصيله (`command_payload`).
2. **البحث عن الوكيل:** يروح لـ "دليل الوكلاء" (جدول `AGENTS`) ويدور على الوكيل المناسب للشغلة هذه. يمكن يدور على حسب نوع الوكيل (`agent_type`) أو أي خصائص ثانية سجلناها في الـ `metadata` حقه.
3. **تحديد المسؤولية:** لما يلاقي الوكيل الصح، يروح السيرفر يعدل الطلب في جدول `REQUESTS` ويسجل فيه الـ `assigned_agent_id` عشان نعرف من هو الوكيل المسؤول عن هذه المهمة.

---

### ⚙️ الخطوة الرابعة: وقت الشغل (التنفيذ الفعلي)

هنا يبدأ الشغل الحقيقي.

1. **إرسال الأمر:** السيرفر يكلم الوكيل اللي اختاره ويرسل له تفاصيل الشغل المطلوب.
2. **الوكيل يشتغل:** الوكيل يستلم الأمر ويبدأ ينفذه.
3. **المتابعة:** في هذا الوقت، العميل يقدر في أي لحظة يستخدم رقم المتابعة حقه ويسأل السيرفر: "ها، ايش صار على طلبي؟" والسيرفر بيرد عليه بالحالة المسجلة عنده في الداتابيز.

---

### 📝 الخطوة الخامسة: التوثيق وإغلاق الملف

هذه آخر خطوة، نتأكد فيها إن كل شي توثق وانحفظ.

1. **استلام النتيجة:** لما الوكيل يخلص، يرجع النتيجة للسيرفر (سواء نجح أو فشل).
2. **تحديث الحالة:** السيرفر يعدل حالة الطلب في جدول `REQUESTS` ويخليها `completed` أو `failed`.
3. **الأرشفة (التدقيق):** وهذه أهم نقطة، السيرفر يسوي نسخة كاملة من كل اللي حصل في جدول `COMMAND_HISTORY`. هذا الجدول هو الصندوق الأسود حقنا، فيه كل شي: من طلب، ومن نفذ، ومتى، وإيش كانت النتيجة. هذا مهم قوي عشان لو حصلت أي مشكلة في المستقبل نعرف سببها.
4. **النهاية:** وبكذا تكون دورة حياة الطلب اكتملت تمامًا واتوثقت.